openapi: 3.1.0
info:
  title: LLM Permission Proxy API
  version: 0.2.0
servers:
  - url: https://proxy.internal
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    MtlsSubject:
      in: header
      name: x-client-subject
      required: true
      schema:
        type: string
      description: Gateway-provided mTLS subject.
    MtlsSubjectTs:
      in: header
      name: x-client-subject-ts
      required: true
      schema:
        type: integer
      description: Unix timestamp used for mTLS subject signature verification.
    MtlsSubjectSig:
      in: header
      name: x-client-subject-sig
      required: true
      schema:
        type: string
      description: hex(HMAC_SHA256(MTLS_BINDING_SHARED_SECRET, "{subject}\n{unix_ts}")).
    IdempotencyKey:
      in: header
      name: idempotency-key
      required: true
      schema:
        type: string
paths:
  /v1/healthz:
    get:
      summary: Liveness probe
  /v1/readyz:
    get:
      summary: Readiness probe

  /v1/tasks:
    post:
      summary: Create task and issue task-scoped capability token
      description: Requires bootstrap JWT plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'

  /v1/tasks/{task_id}:
    get:
      summary: Get task
      description: Requires capability JWT plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'

  /v1/tasks/{task_id}/plan:
    post:
      summary: Plan operation and evaluate approval requirement
      description: Requires capability JWT plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'

  /v1/tasks/{task_id}/apply:
    post:
      summary: Apply operation or return requires_approval
      description: Requires capability JWT plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/IdempotencyKey'
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'

  /v1/tasks/{task_id}/apply/continue:
    post:
      summary: Continue apply after approval using resume token
      description: Requires capability JWT plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/IdempotencyKey'
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'

  /v1/tasks/{task_id}/approval-status:
    get:
      summary: Get approval state
      description: Requires capability JWT plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'

  /v1/tasks/{task_id}/approve:
    post:
      summary: Create approval request
      description: Requires capability JWT plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'

  /v1/tasks/{task_id}/approve/discord-message:
    get:
      summary: Get approval link payload for Discord
      description: Requires capability JWT plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'

  /v1/tasks/{task_id}/dns/create:
    post:
      summary: Convenience DNS create endpoint
      description: Requires capability JWT plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/IdempotencyKey'
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'

  /v1/tasks/{task_id}/cache/purge:
    post:
      summary: Convenience cache purge endpoint
      description: Requires capability JWT plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/IdempotencyKey'
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'

  /v1/tasks/{task_id}/workers/deploy:
    post:
      summary: Convenience workers deploy endpoint
      description: Requires capability JWT plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: task_id
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/IdempotencyKey'
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'

  /v1/agents/{agent_id}/permissions:
    get:
      summary: Read pre-approved permissions
      description: Requires bootstrap JWT with permission-management claims plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: agent_id
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'
    patch:
      summary: Replace pre-approved permissions
      description: Requires bootstrap JWT with permission-management claims plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: agent_id
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'

  /v1/approvers/{approver_principal}/credentials:
    get:
      summary: List passkey credentials for approver principal
      description: Requires bootstrap JWT with approver-management claims plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: approver_principal
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'
    post:
      summary: Upsert passkey credential metadata
      description: Requires bootstrap JWT with approver-management claims plus signed mTLS headers.
      security:
        - bearerAuth: []
      parameters:
        - in: path
          name: approver_principal
          required: true
          schema:
            type: string
        - $ref: '#/components/parameters/MtlsSubject'
        - $ref: '#/components/parameters/MtlsSubjectTs'
        - $ref: '#/components/parameters/MtlsSubjectSig'

  /v1/approve/{approval_nonce}:
    get:
      summary: Approval UI page
      description: `approval_nonce` is a signed opaque approval-link token.
      parameters:
        - in: path
          name: approval_nonce
          required: true
          schema:
            type: string

  /v1/approve/{approval_nonce}/options:
    get:
      summary: WebAuthn challenge options
      parameters:
        - in: path
          name: approval_nonce
          required: true
          schema:
            type: string

  /v1/approve/{approval_nonce}/verify:
    post:
      summary: Verify WebAuthn assertion and approve
      description: >
        Validates full WebAuthn assertion including clientDataJSON, authenticatorData
        (rpIdHash and UP/UV flags), and ES256 signature against stored credential key material.
      parameters:
        - in: path
          name: approval_nonce
          required: true
          schema:
            type: string
